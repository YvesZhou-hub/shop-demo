<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Shop Demo - 商品列表</title>
    <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
<header>
    <div class="brand">
        <h1>Shop Demo</h1>
        <nav>
            <a href="index.html">首页</a>
            <a href="admin.html">商品管理</a>
            <a href="cart.html">购物车 <span class="cart-badge" style="display:none"></span></a>
        </nav>
    </div>
</header>

<main>
    <section id="product-list-section">
        <h2>商品列表</h2>
        <div id="loading">加载中…</div>
        <ul id="product-list" class="product-list"></ul>
    </section>
</main>

<footer>
    <small>示例商店 — 前端演示</small>
</footer>

<script src="assets/app.js"></script>
<script>
    const api = new ApiClient();

    async function renderProductList() {
        const listEl = document.getElementById('product-list');
        const loading = document.getElementById('loading');
        try {
            const res = await api.getAllProducts();
            loading.style.display = 'none';
            if (!res || !res.data || res.data.length === 0) {
                listEl.innerHTML = '<li class="empty">暂无商品</li>';
                return;
            }
            listEl.innerHTML = '';
            res.data.forEach(p => {
                const li = document.createElement('li');
                li.className = 'product-item';
                li.innerHTML = `
            <div class="product-main">
              <div class="product-name">${escapeHtml(p.productName || '未命名')}</div>
              <div class="product-price">价格: ¥${Number(p.price ?? 0).toFixed(2)}</div>
              <div class="product-stock">库存: ${p.stock ?? 0}</div>
            </div>
            <div class="product-actions">
              <a class="btn" href="product.html?id=${encodeURIComponent(p.id)}">查看</a>
              <button class="btn add-cart" data-id="${encodeURIComponent(p.id)}">加入购物车</button>
            </div>
          `;
                listEl.appendChild(li);
            });

            // 绑定加入购物车事件
            listEl.querySelectorAll('.add-cart').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = btn.getAttribute('data-id');
                    try {
                        const r = await api.getProductById(id);
                        if (!r || !r.data) {
                            alert('商品不存在或已下架');
                            return;
                        }
                        const p = r.data;
                        api.addToCart({
                            productId: p.id,
                            productName: p.productName,
                            price: p.price,
                            stock: p.stock,
                            qty: 1
                        });
                        alert('已加入购物车');
                    } catch (err) {
                        console.error(err);
                        alert('添加购物车失败');
                    }
                });
            });

        } catch (err) {
            loading.textContent = '加载失败，请刷新。';
            console.error(err);
        }
    }

    document.addEventListener('DOMContentLoaded', renderProductList);
</script>
</body>
</html>