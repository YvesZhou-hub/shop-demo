<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.demo.mapper.ProductMapper">
    <!-- 查询所有商品：数据库商品名称字段是 name，映射到实体类 productName -->
    <select id="selectAll" resultType="com.shop.demo.entity.Product">
        SELECT
        id,
        name as productName,  -- 数据库字段 name → 实体类 productName
        price,
        stock,
        description,
        create_time as createTime  -- 数据库字段 create_time → 实体类 createTime
        FROM "product"  <!-- 加上双引号，适配 Postgres -->
    </select>

    <!-- 根据ID查询商品 -->
    <select id="selectById" parameterType="Long" resultType="com.shop.demo.entity.Product">
        SELECT
            id,
            name as productName,
            price,
            stock,
            description,
            create_time as createTime
        FROM "product"
        WHERE id = #{id}
    </select>

    <!-- 悲观锁查询：用于库存更新防并发 -->
    <select id="selectByIdForUpdate" parameterType="Long" resultType="com.shop.demo.entity.Product">
        SELECT
            id,
            name as productName,
            price,
            stock,
            description,
            create_time as createTime
        FROM "product"
        WHERE id = #{id}
            FOR UPDATE  -- Postgres 也支持 FOR UPDATE 行锁
    </select>

    <!-- 更新库存 -->
    <update id="updateStock">
        UPDATE "product"
        SET stock = #{newStock}
        WHERE id = #{productId}
          AND stock >= #{buyNum}  -- 库存充足校验
    </update>

    <!-- 插入商品 -->
    <!-- useGeneratedKeys="true" 在 Postgres 中会自动转换为 RETURNING id -->
    <insert id="insertProduct" parameterType="com.shop.demo.entity.Product" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO "product" (
            name,  -- 数据库字段名
            price,
            stock,
            description,
            create_time
        ) VALUES (
                     #{productName},  -- 实体类属性名
                     #{price},
                     #{stock},
                     #{description},
                     CURRENT_TIMESTAMP  -- Postgres 支持 CURRENT_TIMESTAMP
                 )
    </insert>
</mapper>