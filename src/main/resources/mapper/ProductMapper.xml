<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.demo.mapper.ProductMapper">
    <!-- 修复商品名称字段映射（name -> product_name） -->
    <select id="selectAll" resultType="Product">
        SELECT id, product_name as productName, price, stock, description, create_time as createTime FROM product
    </select>

    <!-- 修复商品名称字段映射 -->
    <select id="selectById" parameterType="Long" resultType="Product">
        SELECT id, product_name as productName, price, stock, description, create_time as createTime FROM product WHERE id = #{id}
    </select>

    <!-- 新增带悲观锁的查询（FOR UPDATE） -->
    <select id="selectByIdForUpdate" parameterType="Long" resultType="Product">
        SELECT id, product_name as productName, price, stock, description, create_time as createTime
        FROM product
        WHERE id = #{id}
        FOR UPDATE  <!-- 悲观锁，防止并发更新 -->
    </select>

    <!-- 修复库存更新条件（stock >= 购买数量） -->
    <update id="updateStock">
        UPDATE product
        SET stock = #{newStock}, update_time = CURRENT_TIMESTAMP
        WHERE id = #{productId}
        AND stock >= #{buyNum}  <!-- 确保扣减后库存不为负 -->
    </update>
</mapper>